name: housekeeping

on:
  schedule:
    - cron: "17 3 * * *"   # daily at 03:17 UTC
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  prune-actions-storage:
    runs-on: ubuntu-latest
    steps:
      - name: Delete caches older than 7 days
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cutoff="$(date -u -d '7 days ago' +%s)"
          gh cache list --repo ${{ github.repository }} | while read -r id key size created rest; do
            ts="$(date -u -d "$created" +%s)"
            if [ "$ts" -lt "$cutoff" ]; then
              echo "Deleting cache ID $id (key: $key, created $created)"
              gh cache delete "$id" --repo ${{ github.repository }} || true
            fi
          done
